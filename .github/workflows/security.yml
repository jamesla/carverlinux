name: Security & Sensitive Data

on:
  pull_request:
    branches: [ main ]

jobs:
  secret-detection:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install ripgrep
        run: sudo apt-get update && sudo apt-get install -y ripgrep

      - name: Scan for private keys
        run: |
          echo "Scanning for private keys..."
          failed=false
          
          # Check for RSA private keys
          if rg -U "-----BEGIN (RSA |OPENSSH |DSA |EC |PGP )?PRIVATE KEY-----" --type-add 'nix:*.nix' --type nix .; then
            echo "❌ Found potential private key in repository"
            failed=true
          fi
          
          # Check for potential AWS keys
          if rg -i "AKIA[0-9A-Z]{16}" --type-add 'nix:*.nix' --type nix .; then
            echo "❌ Found potential AWS access key"
            failed=true
          fi
          
          # Check for GitHub tokens
          if rg -i "ghp_[a-zA-Z0-9]{36}" --type-add 'nix:*.nix' --type nix .; then
            echo "❌ Found potential GitHub token"
            failed=true
          fi
          
          if [ "$failed" = true ]; then
            exit 1
          fi

      - name: Scan for passwords and tokens
        run: |
          echo "Scanning for passwords and tokens..."
          failed=false
          
          # Check for password fields
          if rg -i "password\s*=\s*['\"]" --type-add 'nix:*.nix' --type nix .; then
            echo "❌ Found potential hardcoded password"
            failed=true
          fi
          
          # Check for API keys
          if rg -i "api[_-]?key\s*=\s*['\"]" --type-add 'nix:*.nix' --type nix .; then
            echo "❌ Found potential hardcoded API key"
            failed=true
          fi
          
          # Check for tokens
          if rg -i "token\s*=\s*['\"]" --type-add 'nix:*.nix' --type nix .; then
            echo "❌ Found potential hardcoded token"
            failed=true
          fi
          
          if [ "$failed" = true ]; then
            exit 1
          fi

      - name: Validate SSH key in configuration
        run: |
          echo "Validating SSH key in configuration.nix..."
          
          # Extract SSH key from configuration.nix
          ssh_key=$(grep -A1 "authorizedKeys.keys" configuration.nix | grep "ssh-rsa" | sed 's/.*ssh-rsa/ssh-rsa/' | sed 's/".*//')
          
          if [ -z "$ssh_key" ]; then
            echo "❌ SSH key not found in expected location"
            exit 1
          fi
          
          # Check if it's actually a public key (starts with ssh-rsa)
          if [[ ! "$ssh_key" =~ ^ssh-rsa ]]; then
            echo "❌ SSH key in configuration.nix is not a proper public key"
            exit 1
          fi
          
          # Check if key looks like a private key (contains PRIVATE KEY)
          if [[ "$ssh_key" =~ PRIVATE.*KEY ]]; then
            echo "❌ Found private key in configuration.nix - should be public key only"
            exit 1
          fi
          
          echo "✅ SSH key validation passed"

  security-best-practices:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for hardcoded paths
        run: |
          echo "Checking for hardcoded sensitive paths..."
          failed=false
          
          # Check for hardcoded user paths (except /nix/store which is normal)
          if rg "/home/[a-zA-Z0-9]+" --type-add 'nix:*.nix' --type nix . | grep -v "/nix/store"; then
            echo "❌ Found hardcoded user path in configuration"
            failed=true
          fi
          
          # Check for hardcoded IP addresses
          if rg -E '\b[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\b' --type-add 'nix:*.nix' --type nix .; then
            echo "❌ Found hardcoded IP address"
            failed=true
          fi
          
          if [ "$failed" = true ]; then
            exit 1
          fi

      - name: Validate Chromium extensions
        run: |
          echo "Validating Chromium extensions..."
          
          # Get extension IDs from chromium.nix
          extensions=$(grep -o '"[^"]*"' packages/chromium.nix | tr -d '"' | grep -E '^[a-z]{32}$')
          
          for ext_id in $extensions; do
            echo "Checking extension: $ext_id"
            
            # Basic validation - check if it's a valid Chrome extension ID format
            if [[ ! "$ext_id" =~ ^[a-z]{32}$ ]]; then
              echo "❌ Invalid extension ID format: $ext_id"
              exit 1
            fi
          done
          
          echo "✅ Chromium extensions validation passed"

      - name: Check for exposed configurations
        run: |
          echo "Checking for exposed sensitive configurations..."
          failed=false
          
          # Check for database connection strings
          if rg -i "mysql://|postgresql://|mongodb://" --type-add 'nix:*.nix' --type nix .; then
            echo "❌ Found potential database connection string"
            failed=true
          fi
          
          # Check for URLs with credentials
          if rg -i "https?://[^:]*:[^@]*@" --type-add 'nix:*.nix' --type nix .; then
            echo "❌ Found URL with embedded credentials"
            failed=true
          fi
          
          if [ "$failed" = true ]; then
            exit 1
          fi

  email-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check email addresses
        run: |
          echo "Validating email addresses in configuration..."
          
          # Find email in git configuration
          email=$(grep "email.*=" packages/git.nix | sed 's/.*email.*=.*"\([^"]*\)".*/\1/')
          
          if [ -z "$email" ]; then
            echo "❌ No email found in git configuration"
            exit 1
          fi
          
          # Basic email format validation
          if [[ ! "$email" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
            echo "❌ Invalid email format: $email"
            exit 1
          fi
          
          echo "✅ Email validation passed: $email"