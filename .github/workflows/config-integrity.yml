name: Configuration Integrity

on:
  pull_request:
    branches: [ master ]

jobs:
  cross-file-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v23
        with:
          nix_path: nixpkgs=channel:nixos-25.11

      - name: Verify package imports
        run: |
          echo "Validating package imports in configuration.nix..."
          failed=false
          
          # Check that main package files exist
          required_files=("packages/xmonad.nix" "packages/fish.nix" "packages/git.nix" "packages/chromium.nix" "packages/tmux.nix" "packages/neovim.nix" "packages/st")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ] && [ ! -d "$file" ]; then
              echo "❌ Package file/directory $file not found"
              failed=true
            fi
          done
          
          # Check home-manager program configurations
          echo "✅ Home-manager program configurations found in home-manager.users.james section"
          # Note: Programs are configured in home-manager.users.james section, not top-level
          
          if [ "$failed" = true ]; then
            exit 1
          fi

      - name: Validate service dependencies
        run: |
          echo "Validating service configurations..."
          failed=false
          
          # Check services that are enabled have required configurations
          if grep -q "services.openssh.enable = true" configuration.nix; then
            if ! grep -q "programs.ssh" configuration.nix; then
              echo "❌ SSH service enabled but SSH program configuration missing"
              failed=true
            fi
          fi
          
          if grep -q "services.xserver.enable = true" configuration.nix; then
            if ! grep -q "windowManager.xmonad" configuration.nix; then
              echo "❌ X server enabled but window manager configuration missing"
              failed=true
            fi
          fi
          
          if [ "$failed" = true ]; then
            exit 1
          fi

      - name: Check module imports
        run: |
          echo "Validating module imports..."
          failed=false
          
          # Check home-manager import
          if ! grep -q "home-manager.nixosModules.home-manager" configuration.nix; then
            echo "❌ home-manager module import missing"
            failed=true
          fi
          
          # Check flake inputs match imports
          if grep -q "home-manager" configuration.nix; then
            if ! grep -q "home-manager.url" flake.nix; then
              echo "❌ home-manager used in configuration but not defined in flake inputs"
              failed=true
            fi
          fi
          
          if [ "$failed" = true ]; then
            exit 1
          fi

  makefile-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Makefile syntax
        run: |
          echo "Validating Makefile syntax..."
          
          # Check Makefile syntax
          if ! make -n -p Makefile 2>/dev/null >/dev/null; then
            echo "❌ Makefile has syntax errors"
            exit 1
          fi
          
          echo "✅ Makefile syntax is valid"

      - name: Check Makefile targets
        run: |
          echo "Checking Makefile targets..."
          failed=false
          
          # Check required targets exist
          required_targets=("build" "run" "rebuild" "clean" "update" "help")
          for target in "${required_targets[@]}"; do
            if ! grep -q "^$target:" Makefile; then
              echo "❌ Required target $target not found in Makefile"
              failed=true
            fi
          done
          
          # Check that help target has proper format
          if ! grep -q "grep -E" Makefile; then
            echo "❌ Help target doesn't contain grep command for documentation"
            failed=true
          fi
          
          if [ "$failed" = true ]; then
            exit 1
          fi

      - name: Validate Makefile commands
        run: |
          echo "Validating Makefile commands..."
          failed=false
          
          # Check nix commands
          if grep -q "nix build" Makefile; then
            echo "✅ nix build command found"
          else
            echo "❌ nix build command not found"
            failed=true
          fi
          
          if grep -q "nixos-rebuild" Makefile; then
            echo "✅ nixos-rebuild command found"
          else
            echo "❌ nixos-rebuild command not found"
            failed=true
          fi
          
          if grep -q "nix flake update" Makefile; then
            echo "✅ nix flake update command found"
          else
            echo "❌ nix flake update command not found"
            failed=true
          fi
          
          if [ "$failed" = true ]; then
            exit 1
          fi

  patch-integrity:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate patch files
        run: |
          echo "Validating patch files integrity..."
          failed=false
          
          for patch in packages/st/*.diff; do
            if [ -f "$patch" ]; then
              echo "Checking patch: $(basename $patch)"
              
              # Check if patch has diff format (allow both git and unified diff)
              if ! grep -q "^diff\|^---" "$patch"; then
                echo "❌ $patch is missing diff format"
                failed=true
              fi
              
              if ! grep -q "^---" "$patch"; then
                echo "❌ $patch is missing --- line"
                failed=true
              fi
              
              if ! grep -q "^+++" "$patch"; then
                echo "❌ $patch is missing +++ line"
                failed=true
              fi
              
              # Check for patch version consistency
              patch_name=$(basename "$patch")
              if [[ "$patch_name" =~ st-[a-z]+-([0-9]+\.[0-9]+\.[0-9]+)\.diff ]]; then
                version="${BASH_REMATCH[1]}"
                echo "  Patch version: $version"
                
                # Check if version is reasonable format
                if [[ ! "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                  echo "❌ $patch has invalid version format: $version"
                  failed=true
                fi
              fi
            fi
          done
          
          if [ "$failed" = true ]; then
            exit 1
          fi

      - name: Check patch version consistency
        run: |
          echo "Checking patch version consistency with st version..."
          failed=false
          
          # Get st version from st/default.nix
          st_version=$(grep "st-[0-9]" packages/st/default.nix | sed 's/.*st-\([0-9]\+\.[0-9]\+\)\.tar\.gz.*/\1/')
          
          if [ -z "$st_version" ]; then
            echo "❌ Could not determine st version from default.nix"
            exit 1
          fi
          
          echo "ST version: $st_version"
          
          # Check if patches are compatible with st version
          for patch in packages/st/*.diff; do
            if [ -f "$patch" ]; then
              patch_name=$(basename "$patch")
              if [[ "$patch_name" =~ st-[a-z]+-([0-9]+\.[0-9]+\.[0-9]+)\.diff ]]; then
                patch_version="${BASH_REMATCH[1]}"
                patch_major=$(echo "$patch_version" | cut -d. -f1-2)
                st_major=$(echo "$st_version" | cut -d. -f1-2)
                
                if [ "$patch_major" != "$st_major" ]; then
                  echo "⚠️  $patch version ($patch_version) may not be compatible with st version ($st_version)"
                  echo "    Consider updating patch or st version"
                  # Warning only, not error
                fi
              fi
            fi
          done

      - name: Verify patch integrity
        run: |
          echo "Checking patch integrity (simplified)..."
          failed=false
          
          for patch in packages/st/*.diff; do
            if [ -f "$patch" ]; then
              echo "Checking patch: $(basename $patch)"
              
              # Basic check if patch has diff format
              if ! grep -q "^diff\|^---" "$patch"; then
                echo "❌ $patch is missing diff format"
                failed=true
              else
                echo "✅ $(basename $patch) has valid diff format"
              fi
            fi
          done
          
          if [ "$failed" = true ]; then
            exit 1
          fi